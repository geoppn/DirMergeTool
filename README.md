Εργασία 4 - Λειτουργικά Συστήματα
Γεώργιος Παπαϊωάννου - 1115202100222
Δαμιανός Πούλιας - 1115202100160

Εντολές Make :
make        -> Δημιουργία εκτελέσιμου
make clean  -> Διαγραφή εκτελέσιμου/αντικειμενικών αρχείων
make rdir   -> Διαγραφή default DIR3 (Merged Directory)

Εντολή Εκτέλεσης :
./cmpcat -d DIR1 DIR2 [-s DIR3]

(Ανεξαρτήτου σειράς & ονομάτων των Directories DIR1 DIR2 [DIR3])

Για την επίδειξη της ορθής λειτουργίας του προγράμματος δινόνται τα DIR1 & DIR2 :
Τα οποία καλύπτουν όλες τις περιπτώσεις που ορίζονται από την εκφώνηση.

Υλοποίηση προβλήματος:

Για την εργασία αυτή, αποφασίσαμε να δημιουργήσουμε ένα ζεύγος αρχείων .h και πηγαίου κώδικα που χειρίζονται τις διάφορες συναρτήσεις που χρησιμοποιούνται για την επίτευξη του στόχου μας, μαζί με ένα κύριο αρχείο πηγαίου κώδικα που χειρίζεται σωστά τις εισόδους, τις κλήσεις συναρτήσεων και την αρχικοποίηση της μνήμης. Όπως αναφέρθηκε προηγουμένως, παρέχουμε επίσης το ζητούμενο Makefile και ένα απλό παράδειγμα για να καλύψουμε τις περισσότερες περιπτώσεις διαφορών.

Μέσα στο αρχείο κεφαλίδας μας, περιλαμβάνουμε τις περισσότερες από τις απαιτούμενες βιβλιοθήκες που βοηθούν στην υλοποίηση του έργου μας. Ξεκινώντας, για να αυξήσουμε δραστικά την αναγνωσιμότητα του κώδικά μας, ορίζουμε τις μεταβλητές "EXISTS" και "NOTEXISTS" που χρησιμοποιούνται στις συναρτήσεις μας για να δηλώνουν αν μια καταχώρηση υπάρχει. Χρησιμοποιούμε επίσης ένα enum για να καθορίσουμε τον τύπο κάθε καταχώρησης dirent για μελλοντική χρήση. Στη συνέχεια, δηλώνουμε την κύρια δομή μας που συγκρατεί όλες τις απαραίτητες πληροφορίες για κάθε καταχώρηση, οι οποίες αποτελούνται από: την απόλυτη διαδρομή της για συγκρίσεις και πρόσβαση, τη σχετική διαδρομή της για σκοπούς εκτύπωσης, το όνομά της, το μέγεθός της σε bytes, την ημερομηνία της τελευταίας τροποποίησης εντός της καταχώρησης (για σύγκριση όταν υποδηλώνεται από την εκφώνηση), το id του i-node για συγκρίσεις hard link, έναν δείκτη link για soft links και τον τύπο. Τέλος, δηλώνουμε επικεφαλίδες συναρτήσεων για όλες τις κύριες συναρτήσεις μας και τις βοηθητικές συναρτήσεις που βοηθούν στην ευρύτερη εικόνα.

Για την υλοποίηση των συναρτήσεων, έχουμε:
compare_files() η οποία ανοίγει δύο αρχεία που παρέχονται, ελέγχει την εγκυρότητά τους και στη συνέχεια συγκρίνει τα περιεχόμενά τους χαρακτήρα προς χαρακτήρα (όπως ζητείται στην επικεφαλίδα) και επιστρέφει ένα αποτέλεσμα. Έχουμε επίσης την file_exists() η οποία χρησιμοποιεί την κλήση access() για να δηλώσει αν η απόλυτη διαδρομή προς ένα αρχείο είναι σωστή και το αρχείο υπάρχει, παράλληλα με την directory_exists() η οποία εξυπηρετεί παρόμοιο σκοπό χρησιμοποιώντας την stat(). Τέλος, έχουμε το σετ copy_directory() και copy_file() που δημιουργούν αντίστοιχα ένα άμεσο αντίγραφο των καταλόγων και των αρχείων που παρέχονται. Χρησιμοποιούμε τη βιβλιοθήκη dirent για να επιτύχουμε την αντιγραφή καταλόγων, παράλληλα με μια αναδρομική κλήση αν χρειαστεί για εμφωλευμένους καταλόγους και την copy_file για άλλα αρχεία μέσα σε αυτούς. Όσον αφορά την copy_file, απλά προσπελαύνουμε αρχεία, ελέγχουμε την εγκυρότητά τους και χρησιμοποιούμε τις fputc και fgetc για να δημιουργήσουμε ένα αντίγραφο τους.

Τώρα για τις κύριες συναρτήσεις, έχουμε:

read_directory(), στην οποία δίνεται ένα μονοπάτι και δημιουργεί έναν πίνακα εγγραφών EntryInfo που αργότερα παρέχουμε στις άλλες συναρτήσεις για πιο εντατική εργασία. Στην πρώτη κλήση της συνάρτησης (αφού είναι αναδρομική για εμφωλευμένους καταλόγους), αποθηκεύουμε το αρχικό μήκος του ονόματος του πρώτου καταλόγου, καθώς πρέπει να το αφαιρέσουμε για τη σχετική διαδρομή. Στη συνέχεια, έχουμε τον κύριο βρόχο while που περνάει από όλες τις καταχωρήσεις μέσα στον κατάλογο χρησιμοποιώντας τη dirent. Με τη χρήση της απόλυτης διαδρομής, παίρνουμε τις πληροφορίες του i-κόμβου και στη συνέχεια είμαστε έτοιμοι να αρχειοθετήσουμε την καταχώρηση. Έχουμε επίσης μια συνθήκη που αυξάνει το μέγεθος του δυναμικού μας πίνακα σε περίπτωση που χρειαστεί, για να παρέχει εύρος και να αποτρέψει τη σπατάλη μνήμης. Τώρα, για κάθε καταχώρηση αρχικοποιούμε κάποιες πληροφορίες που είναι αποκλειστικές για έναν μόνο τύπο καταχωρήσεων και χρησιμοποιώντας τις πληροφορίες i-node και κάποιους άλλους απλούς υπολογισμούς, γεμίζουμε τις ανάγκες της δομής για κάθε καταχώρηση. Μόλις ο κατάλογος και όλοι οι υποκατάλογοι του διαβαστούν πλήρως, ο κατάλογος κλείνει και έχουμε το τελικό μας αποτέλεσμα. Οι παράμετροι μας για αυτή τη συνάρτηση περιλαμβάνουν κάποιες επιπλέον πληροφορίες λόγω της ανάγκης για αναδρομής.\

compare_directories πρόκειται για την συνάρτηση η οποία συγκρίνει τους δύο καταλόγους και εκτυπώνει τις διαφορές τους. Η λειτουργία αυτή επιτυγχάνεται μέσω των επαναλήψεων που γίνονται για κάθε καταχώρηση των δύο directories. Στις επαναλήψεις αυτές γίνονται όλες οι απαραίτητες συγκρίσεις (όνομα-σχετικό μονοπάτι-links) προκειμένου να παραχθεί το επιθυμητό αποτέλεσμα. Πιο συγκεκριμένα, για τον πρώτο κατάλογο ελεγχέται για κάθε καταχώρηση η αντιστοιχία της, με αυτές του δευτέρου, σύμφωνα με τις προϋποθέσεις που ορίζονται από την εκφώνηση. Σε περίπτωση που δεν βρεθεί αντίστοιχη καταχώρηση στο directory 2 εκτυπώνεται το σχετικό μονοπάτι της καταχώρησης του directory 1 που βρίσκεται υπό σύγκριση. Η ίδια διαδικασία επαναλαμβάνεται και για τον δεύτερο κατάλογο.

merge_directories : Πρόκειται για την συνάρτηση συγχώνευσης των δύο δεδομένων directories σε έναν τρίτο καινούργιο/ήδη υφιστάμενο κατάλογο. Ο τρόπος με τον οποίο η λειτουργία αυτή καθίσταται εφικτή είναι ο εξής : 1. Ελέγχεται αν ο κατάλογος προορισμού (merged) ήδη υφίσται, αν όχι δημιουργείται. 2. Κάθε καταχώρηση του πρώτου καταλόγου αντιγράφεται στον καινούργιο κατάλογο, αφού πρώτα ελεγχθεί ο τύπος της καταχώρησης προκειμένου αυτή να αντιγραφεί με έγκυρο τρόπο. 3. Αν η καταχώρηση αποτελεί ήδη υπάρχον, στο Directory 3, αρχείο τότε διατηρείται το αρχείο με την πιο πρόσφατη ημερομηνία τροποποίησης. 4. Τέλος η διαδικασία αυτή επαναλαμβάνεται και για το directory 2.

Στην main : 
1. Επικυρώνονται τα ορίσματα γραμμής εντολών και πραγματοποιείται έλεγχος χρήσης της -s σημαίας. 2. Αρχικοποιούνται οι πίνακες οι οποίοι πρόκειται να αποθηκεύσουν πληροφορίες οι οποίες αφορούν τις καταχωρήσεις των δύο directories. 3. Μέσω της συνάρτησης read_directories γίνεται ανάγνωση και σχετική ενημέρωση των dirInfo και αλλών χρήσιμων για την εκτέλεση μεταβλητών. 4. Καλείται η compare_directories που βρίσκει και εκτυπώνει τις διαφορές των δύο καταλόγων. 5. Αν η σημαία -s χρησιμοποιήθηκε πραγματοποιείται συγχώνευση των δύο καταλόγων. 6. Τέλος, απελευθερώνεται η μνήμη που δεσμεύτηκε. 

